#!/bin/bash
#
# sct_test_lib
#
# (c) 2025 SUSE LLC
# Author: F.Herschel, L.Pinne.
# GNU General Public License v2. No warranty.
# http://www.gnu.org/licenses/gpl.html
set -u

function init()
{
    G_CMD_CRM="/usr/sbin/crm"
    G_CMD_CRMATTR="/usr/sbin/crm_attribute"
    G_CMD_IPTABLES="/usr/sbin/iptables"
    G_CMD_SYSTEMCTL="/usr/bin/systemctl"
    G_CMD_SHOWATTR="/usr/bin/SAPHanaSR-showAttr"   # for 'classic' you need the SAPHanaSR-tester-client package
    G_CMD_SAPCONTROL="sapcontrol"                  # maybe we need the full path in the future (for sudo-i-fy)
    G_CMD_HDBNSUTIL="hdbnsutil"                    # maybe we need the full path in the future (for sudo-i-fy)
    G_CMD_HDBSQL="hdbsql"                          # maybe we need the full path in the future (for sudo-i-fy)
    G_CMD_SAP_PYTHON3="python3"                    # maybe we need the full path in the future (for sudo-i-fy)
    G_CMD_FSFREEZE="/sbin/fsfreeze"
    G_CMD_RCNETWORK="/sbin/rcnetwork"
    G_CMD_CIBADMIN="/usr/sbin/cibadmin"
    G_CMD_CAT="/usr/bin/cat"
}

#
# cluster calls either need root or user with haclient group
#
function get_curr_prim()
{
    # get_curr_prim <node>
    local currPrimary
    local node01="$1"
    currPrimary="$(ssh "${node01}" "$G_CMD_SHOWATTR --format=tester" | awk -F'/' '/score="150"/ { print $2 }' )"
    echo "$currPrimary"
    return 0
}

function get_curr_secn()
{
    # get_curr_secn <node>
    local currSecondary
    local node01="$1"
    currSecondary="$(ssh "${node01}" "$G_CMD_SHOWATTR --format=tester" | awk -F'/' '/score="100"/ { print $2 }' )"
    echo "$currSecondary"
    return 0
}

function get_curr_prim_worker()
{
    # get_curr_prim <node>
    local currPrimWorker
    local node01="$1"
    currPrimWorker="$(ssh "${node01}" "$G_CMD_SHOWATTR --format=tester" | awk -F'/' '/score="-10000"/ { print $2 }' )"
    echo "$currPrimWorker"
    return 0
}

function get_curr_secn_worker()
{
    # get_curr_secn_worker <node>
    local currSecnWorker
    local node01="$1"
    currSecnWorker="$(ssh "${node01}" "$G_CMD_SHOWATTR --format=tester" | awk -F'/' '/score="-12200"/ { print $2 }' )"
    echo "$currSecnWorker"
    return 0
}

function get_site()
{
    # get_site <node> <hana-node>
    local site
    local node01="$1"
    local hana_node="$2"
    site=$(ssh "${node01}" "$G_CMD_SHOWATTR --format=tester" | awk -F'=' '$0 ~ node".site" { print $2 }' node="$hana_node")
    site="${site//\"/}"
    echo "$site"
    return 0
}

function get_vhost()
{
    # get_vhost <node> <hana-node>
    local vhost
    local node01="$1"
    local hana_node="$2"
    vhost=$(ssh "${node01}" "$G_CMD_SHOWATTR --format=tester" | awk -F'=' '$0 ~ node".*vhost=" { print $2 }' node="$hana_node")
    vhost="${vhost//\"/}"
    echo "$vhost"
    return 0
}

#
# kill process either need root or process-owner user
#
function kill_process()
{
    # kill_process <node> <proc-user> <proc-pattern> <signal>
    local node01="$1"
    local proc_user="$2"
    local proc_pattern="$3"
    local proc_signal="$4"
    ssh "${node01}" "pgrep -u ${proc_user} -f ${proc_pattern}; pkill -u $proc_user} -f ${proc_pattern}"
    return 0
}

#
# iptables need root user
#
function run_iptables()
{
    # run_iptables <node> <iptables-command> (without 'iptables')
    local node01="$1"
    local iptables_cmd="$2"
    ssh "${node01}" "$G_CMD_IPTABLES $iptables_cmd"
    return 0
}

#
# cluster calls need either root or user with group haclient
#
function run_crm()
{
    # run_crm <node> <crm-command> (without "crm")
    local node01="$1"
    local crm_cmd="$2"
    ssh "${node01}" "$G_CMD_CRM $crm_cmd"
    return 0
}

function run_crmattr()
{
    # run_crmattr <node> <crmattr-command> (without "crm_attribute")
    local node01="$1"
    local crm_attribute_cmd="$2"
    ssh "${node01}" "$G_CMD_CRMATTR $crm_attribute_cmd"
    return 0
}

function run_cibadmin()
{
    # run_cibadmin <node> <cibadmin-command> (without "cibadmin")
    local node01="$1"
    local crm_cibadmin_cmd="$2"
    ssh "${node01}" "$G_CMD_CIBADMIN $crm_cibadmin_cmd"
    return 0
}

#
# system calls need root user
#
function run_systemctl()
{
    # run_systemctl <node> <systemctl-command> (without "systemctl")
    local node01="$1"
    local crm_systemctl_cmd="$2"
    ssh "${node01}" "$G_CMD_SYSTEMCTL $crm_systemctl_cmd"
    return 0
}

function run_fsfreeze()
{
    # run_fsfreeze <node> <fsfreeze-command> (without "fsfreeze")
    local node01="$1"
    local crm_fsfreeze_cmd="$2"
    ssh "${node01}" "$G_CMD_FSFREEZE $crm_fsfreeze_cmd"
    return 0
}

function run_rcnetwork()
{
    # run_rcnetwork <node> <rcnetwork-command> (without "rcnetwork")
    local node01="$1"
    local crm_rcnetwork_cmd="$2"
    ssh "${node01}" "$G_CMD_RCNETWORK $crm_rcnetwork_cmd"
    return 0
}

#
# sap calls need sid-adm user
#
function run_sapcontrol()
{
    # run_sapcontrol <node> <sapcontrol-command> (without "sapcontrol")
    local node01="$1"
    local crm_sapcontrol_cmd="$2"
    ssh "${node01}" "$G_CMD_SAPCONTROL $crm_sapcontrol_cmd"
    return 0
}

function run_sap_python3()
{
    # run_sap_python3 <node> <python3-command> (without "python3")
    local node01="$1"
    local crm_python3_cmd="$2"
    ssh "${node01}" "$G_CMD_SAP_PYTHON3 $crm_python3_cmd"
    return 0
}

function run_hdbsql()
{
    # run_hdbsql <node> <sidadm> <hanauserkey> <hdbsql-query> (without "hdbsql")
    #
    # needs su (or sudo) to <sid>adm
    #
    local node01="$1"
    local sidadm="$2"
    local userkey="$3"
    local hdbsql_query="$4"
    cs_ssh --hosts grauenstein02 --command "sudo -u $sidadm --login hdbsql -U $userkey $hdbsql_query"
    return 0
}

function run_hdbnsutil()
{
    # run_hdbnsutil <node> <hdbnsutil-command> (without "hdbnsutil")
    local node01="$1"
    local crm_hdbnsutil_cmd="$2"
    ssh "${node01}" "su - ha1adm --command='$G_CMD_HDBNSUTIL $crm_hdbnsutil_cmd'"
    return 0
}

#
# cat-file needs either root or file-owner
#
function run_cat()
{
    # run_cat <node> <cat-command> (without "cat")
    local node01="$1"
    local crm_cat_cmd="$2"
    ssh "${node01}" "$G_CMD_CAT $crm_cat_cmd"
    return 0
}

init
